{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_modify %}

{% block title %}{% if errors %}{% translate "Error:" %} {% endif %}{{ block.super }}{% endblock %}

{% block extrahead %}
  {{ block.super }}
  <script src="{% url 'admin:jsi18n' %}"></script>
  {{ adminform.media }}
  {{ media }}
{% endblock %}

{% block extrastyle %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'admin/css/forms.css' %}">
{% endblock %}

{% block bodyclass %}{{ block.super }} app-{{ opts.app_label }} model-{{ opts.model_name }} change-form{% endblock %}

{% if not is_popup %}
  {% block breadcrumbs %}
    <ol class="flex flex-wrap items-center gap-2 text-sm text-gray-500 dark:text-gray-400">
      <li>
        <a class="inline-flex items-center gap-1 rounded-lg px-3 py-1 font-medium text-gray-600 hover:bg-blue-50 hover:text-blue-700 dark:text-gray-300 dark:hover:bg-gray-800 dark:hover:text-white" href="{% url 'admin:index' %}">{% translate 'Home' %}</a>
      </li>
      <li aria-hidden="true" class="text-gray-400">/</li>
      <li>
        <a class="rounded-lg px-3 py-1 text-gray-600 hover:bg-blue-50 hover:text-blue-700 dark:text-gray-300 dark:hover:bg-gray-800 dark:hover:text-white" href="{% url 'admin:app_list' app_label=opts.app_label %}">{{ opts.app_config.verbose_name }}</a>
      </li>
      <li aria-hidden="true" class="text-gray-400">/</li>
      <li>
        {% if has_view_permission %}
          <a class="rounded-lg px-3 py-1 text-gray-600 hover:bg-blue-50 hover:text-blue-700 dark:text-gray-300 dark:hover:bg-gray-800 dark:hover:text-white" href="{% url opts|admin_urlname:'changelist' %}">{{ opts.verbose_name_plural|capfirst }}</a>
        {% else %}
          <span class="rounded-lg px-3 py-1 text-gray-400 dark:text-gray-500">{{ opts.verbose_name_plural|capfirst }}</span>
        {% endif %}
      </li>
      <li aria-hidden="true" class="text-gray-400">/</li>
      <li class="rounded-lg bg-blue-50 px-3 py-1 font-semibold text-blue-700 dark:bg-blue-500/20 dark:text-blue-200">
        {% if add %}
          {% blocktranslate with name=opts.verbose_name %}Add {{ name }}{% endblocktranslate %}
        {% else %}
          {{ original|truncatewords:"18" }}
        {% endif %}
      </li>
    </ol>
  {% endblock %}
{% endif %}

{% block content %}
  <div id="content-main" class="space-y-8">
    {% block object-tools %}
      {% if change and not is_popup %}
        <ul class="object-tools flex flex-wrap items-center justify-end gap-2 text-sm font-medium">
          {% block object-tools-items %}
            {% change_form_object_tools %}
          {% endblock %}
        </ul>
      {% endif %}
    {% endblock %}

    <form {% if has_file_field %}enctype="multipart/form-data" {% endif %}{% if form_url %}action="{{ form_url }}" {% endif %}method="post" id="{{ opts.model_name }}_form" novalidate class="space-y-6">
      {% csrf_token %}
      {% block form_top %}{% endblock %}

      {% if is_popup %}<input type="hidden" name="{{ is_popup_var }}" value="1">{% endif %}
      {% if to_field %}<input type="hidden" name="{{ to_field_var }}" value="{{ to_field }}">{% endif %}

      {% if save_on_top %}
        {% block submit_buttons_top %}
          <div class="rounded-2xl bg-white p-4 shadow-sm ring-1 ring-gray-100 dark:bg-gray-800 dark:ring-gray-700">
            {% submit_row %}
          </div>
        {% endblock %}
      {% endif %}

      {% if errors %}
        <div class="rounded-lg border border-red-200 bg-red-50 p-4 text-sm text-red-800 dark:border-red-900/50 dark:bg-red-900/30 dark:text-red-200">
          <p>
            {% blocktranslate count counter=errors|length %}Please correct the error below.{% plural %}Please correct the errors below.{% endblocktranslate %}
          </p>
          {{ adminform.form.non_field_errors }}
        </div>
      {% endif %}

      {% block field_sets %}
        {% with total_fieldsets=adminform|length %}
          {% if total_fieldsets > 1 %}
            <div class="rounded-2xl border border-gray-200 bg-white shadow-sm dark:border-gray-700 dark:bg-gray-800" data-admin-fieldset-tabs>
              <div class="border-b border-gray-200 px-6 pt-6 dark:border-gray-700">
                <ul
                  class="flex flex-wrap gap-2 text-sm font-medium text-gray-600 dark:text-gray-300"
                  role="tablist"
                  data-tabs-toggle="#admin-fieldset-tab-panels"
                  data-tabs-active-classes="text-blue-700 bg-blue-50 dark:bg-blue-500/20 dark:text-blue-200"
                  data-tabs-inactive-classes="text-gray-600 hover:text-blue-700 dark:text-gray-300 dark:hover:text-white"
                >
                  {% for fieldset in adminform %}
                    {% with heading=fieldset.name %}
                      {% with slug_base=heading|default_if_none:''|slugify %}
                        {% with panel_id=slug_base|default:'fieldset'|add:'-'|add:forloop.counter %}
                          {% with tab_id=panel_id|add:'-tab' %}
                            <li role="presentation">
                              <button
                                class="rounded-lg px-4 py-2 {% if forloop.first %}text-blue-700 bg-blue-50 dark:bg-blue-500/20 dark:text-blue-200{% else %}text-gray-600 hover:text-blue-700 dark:text-gray-300 dark:hover:text-white{% endif %}"
                                id="{{ tab_id }}"
                                type="button"
                                role="tab"
                                aria-controls="{{ panel_id }}"
                                aria-selected="{% if forloop.first %}true{% else %}false{% endif %}"
                                data-tabs-target="#{{ panel_id }}"
                              >
                                {% if heading %}
                                  {{ heading }}
                                {% else %}
                                  {% blocktranslate with counter=forloop.counter %}Section {{ counter }}{% endblocktranslate %}
                                {% endif %}
                              </button>
                            </li>
                          {% endwith %}
                        {% endwith %}
                      {% endwith %}
                    {% endwith %}
                  {% endfor %}
                </ul>
              </div>
              <div id="admin-fieldset-tab-panels" class="pb-6">
                {% for fieldset in adminform %}
                  {% with heading=fieldset.name %}
                    {% with slug_base=heading|default_if_none:''|slugify %}
                      {% with panel_id=slug_base|default:'fieldset'|add:'-'|add:forloop.counter %}
                        {% with tab_id=panel_id|add:'-tab' %}
                          <div
                            id="{{ panel_id }}"
                            role="tabpanel"
                            aria-labelledby="{{ tab_id }}"
                            class="{% if not forloop.first %}hidden {% endif %}p-6"
                          >
                            {% include "admin/includes/fieldset.html" with heading_level=2 prefix="fieldset" id_prefix=0 id_suffix=forloop.counter0 %}
                          </div>
                        {% endwith %}
                      {% endwith %}
                    {% endwith %}
                  {% endwith %}
                {% endfor %}
              </div>
            </div>
          {% else %}
            {% for fieldset in adminform %}
              <div class="rounded-2xl border border-gray-200 bg-white p-6 shadow-sm dark:border-gray-700 dark:bg-gray-800">
                {% include "admin/includes/fieldset.html" with heading_level=2 prefix="fieldset" id_prefix=0 id_suffix=forloop.counter0 %}
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}
      {% endblock %}

      {% block after_field_sets %}{% endblock %}

      {% block inline_field_sets %}
        {% for inline_admin_formset in inline_admin_formsets %}
          <div class="rounded-2xl border border-dashed border-gray-300 bg-white p-6 shadow-sm dark:border-gray-600 dark:bg-gray-800">
            {% include inline_admin_formset.opts.template %}
          </div>
        {% endfor %}
      {% endblock %}

      {% block after_related_objects %}{% endblock %}

      {% block submit_buttons_bottom %}
        <div class="rounded-2xl bg-white p-4 shadow-sm ring-1 ring-gray-100 dark:bg-gray-800 dark:ring-gray-700">
          {% submit_row %}
        </div>
      {% endblock %}

      {% block admin_change_form_document_ready %}
        <script id="django-admin-form-add-constants"
                src="{% static 'admin/js/change_form.js' %}"
                {% if adminform and add %}
                  data-model-name="{{ opts.model_name }}"
                {% endif %}
                async>
        </script>
        <script>
          (function () {
            function setupFieldsetTabs(container, hasFlowbite) {
              var toggle = container.querySelector('[data-tabs-toggle]');
              if (!toggle) {
                return;
              }

              var tabButtons = toggle.querySelectorAll('[role="tab"][data-tabs-target]');
              if (!tabButtons.length) {
                return;
              }

              var panels = container.querySelectorAll('[role="tabpanel"]');
              if (!panels.length) {
                return;
              }

              var activeClasses = (toggle.getAttribute('data-tabs-active-classes') || '')
                .split(/\s+/)
                .filter(Boolean);
              var inactiveClasses = (toggle.getAttribute('data-tabs-inactive-classes') || '')
                .split(/\s+/)
                .filter(Boolean);

              function applyButtonClasses(button, isActive) {
                activeClasses.forEach(function (className) {
                  button.classList.toggle(className, isActive);
                });
                inactiveClasses.forEach(function (className) {
                  button.classList.toggle(className, !isActive);
                });
              }

              function findPanel(button) {
                var targetSelector = button.getAttribute('data-tabs-target');
                if (!targetSelector) {
                  return null;
                }
                return container.querySelector(targetSelector);
              }

              function activateManually(button) {
                var targetPanel = findPanel(button);
                if (!targetPanel) {
                  return;
                }

                Array.prototype.forEach.call(tabButtons, function (tab) {
                  var isActive = tab === button;
                  tab.setAttribute('aria-selected', String(isActive));
                  applyButtonClasses(tab, isActive);
                });

                Array.prototype.forEach.call(panels, function (panel) {
                  panel.classList.toggle('hidden', panel !== targetPanel);
                });
              }

              if (!hasFlowbite) {
                Array.prototype.forEach.call(tabButtons, function (button) {
                  button.addEventListener('click', function (event) {
                    event.preventDefault();
                    activateManually(button);
                  });
                });
              }

              var errorPanel = null;
              if (typeof Array.prototype.find === 'function') {
                errorPanel = Array.prototype.find.call(panels, function (panel) {
                  return panel.querySelector('.errorlist, .errornote, [aria-invalid="true"]');
                });
              } else {
                for (var i = 0; i < panels.length; i += 1) {
                  if (panels[i].querySelector('.errorlist, .errornote, [aria-invalid="true"]')) {
                    errorPanel = panels[i];
                    break;
                  }
                }
              }

              var initialButton = null;
              if (errorPanel && errorPanel.id) {
                Array.prototype.forEach.call(tabButtons, function (button) {
                  if (button.getAttribute('data-tabs-target') === '#' + errorPanel.id) {
                    initialButton = button;
                  }
                });
              }

              if (!initialButton) {
                initialButton = container.querySelector('[role="tab"][aria-selected="true"]') || tabButtons[0];
              }

              if (!initialButton) {
                return;
              }

              if (hasFlowbite) {
                if (typeof initialButton.click === 'function') {
                  initialButton.click();
                }
              } else {
                activateManually(initialButton);
              }
            }

            function initFieldsetTabs() {
              var containers = document.querySelectorAll('[data-admin-fieldset-tabs]');
              if (!containers.length) {
                return;
              }

              var hasFlowbite = typeof window.initFlowbite === 'function';
              if (hasFlowbite) {
                window.initFlowbite();
              }

              Array.prototype.forEach.call(containers, function (container) {
                setupFieldsetTabs(container, hasFlowbite);
              });
            }

            function onReady() {
              initFieldsetTabs();
            }

            if (document.readyState === 'loading') {
              document.addEventListener('DOMContentLoaded', function () {
                window.setTimeout(onReady, 0);
              });
            } else {
              window.setTimeout(onReady, 0);
            }
          })();
        </script>
      {% endblock %}

      {% prepopulated_fields_js %}
    </form>
  </div>
{% endblock %}
